# .github/workflows/sync-dashboards.yml
name: Sync TeslaMate Dashboards

on:
  # Run weekly on Mondays at 2 AM UTC
  schedule:
    - cron: '0 2 * * 1'
  # Allow manual trigger
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Download TeslaMate grafana folder
        run: |
          # Clone with sparse-checkout to get only the grafana folder
          git clone --depth 1 --filter=blob:none --sparse \
            https://github.com/teslamate-org/teslamate.git /tmp/teslamate
          
          cd /tmp/teslamate
          git sparse-checkout set grafana
          
          # Return to workspace
          cd $GITHUB_WORKSPACE
          
          # Create directory structure for dashboards
          mkdir -p dashboards/internal dashboards/reports
          
          # Copy main dashboards (exclude subdirectories)
          find /tmp/teslamate/grafana/dashboards -maxdepth 1 -name "*.json" \
            -exec cp {} ./dashboards/ \;
          
          # Copy internal dashboards
          if [ -d "/tmp/teslamate/grafana/dashboards/internal" ]; then
            cp /tmp/teslamate/grafana/dashboards/internal/*.json ./dashboards/internal/ 2>/dev/null || true
          fi
          
          # Copy reports dashboards
          if [ -d "/tmp/teslamate/grafana/dashboards/reports" ]; then
            cp /tmp/teslamate/grafana/dashboards/reports/*.json ./dashboards/reports/ 2>/dev/null || true
          fi
          
          # Copy configuration files
          cp /tmp/teslamate/grafana/dashboards.yml ./
          cp /tmp/teslamate/grafana/datasource.yml ./
          
          # Copy branding assets
          cp /tmp/teslamate/grafana/logo.svg ./
          cp /tmp/teslamate/grafana/favicon.png ./
          cp /tmp/teslamate/grafana/apple-touch-icon.png ./
          
          # Cleanup
          rm -rf /tmp/teslamate
      
      - name: Check for changes
        id: check
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ“Š Changes detected in dashboards"
            git status --short
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "âœ… No changes detected"
          fi
      
      - name: Get TeslaMate version
        if: steps.check.outputs.changed == 'true'
        id: version
        run: |
          # Try to get the latest tag from TeslaMate repo
          VERSION=$(git ls-remote --tags --refs https://github.com/teslamate-org/teslamate.git | \
            tail -n1 | sed 's/.*\///')
          echo "version=${VERSION:-unknown}" >> $GITHUB_OUTPUT
      
      - name: Create Pull Request
        if: steps.check.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: 'chore(dashboards): sync from TeslaMate upstream'
          committer: GitHub Actions <actions@github.com>
          author: GitHub Actions <actions@github.com>
          title: 'ğŸ”„ Update TeslaMate dashboards'
          body: |
            ## ğŸ”„ Automated sync from TeslaMate upstream
            
            This PR contains updates from the [TeslaMate Grafana folder](https://github.com/teslamate-org/teslamate/tree/main/grafana).
            
            **TeslaMate version:** `${{ steps.version.outputs.version }}`
            
            ### Changes may include:
            - ğŸ“Š Dashboard JSON updates
            - âš™ï¸ Configuration file changes (`dashboards.yml`, `datasource.yml`)
            - ğŸ¨ Branding assets updates
            
            ### Action required:
            - [ ] Review dashboard changes
            - [ ] Test locally if major changes detected
            - [ ] Merge to trigger new image build
            
            ---
            
            **Source:** [teslamate-org/teslamate/grafana](https://github.com/teslamate-org/teslamate/tree/main/grafana)
            
            *This PR was automatically created by the sync-dashboards workflow.*
          branch: sync-dashboards
          delete-branch: true
          labels: |
            dashboards
            automated
            teslamate
          assignees: ${{ github.repository_owner }}